#!/bin/bash

PROGVERSION="0.01"
PROGNAME="chroots"
CHROOTS=$HOME/.chroots

VERBOSE=1

function chroots_check_permissions {
	if [ $UID != 0 ]; then
		echo "Superuser permissions required. Aborting."
		exit 1
	fi;
}

function chroots_version {
	echo "$PROGNAME $PROGVERSION - Copyright (C) Alfredo Matos 2008"
}

function get_work_chroot {
	if [ "$1" == "" ]; then
        	get_default_chroot;
	        echo "Using default chroot $DEFAULT_CHRNAME";
        	_CHRNAME=$DEFAULT_CHRNAME;
	else
        	_CHRNAME=$1;
	fi;
}

function get_default_chroot {
	if [ -r /etc/lsb-release ]; then
		. /etc/lsb-release
		DEFAULT_CHRNAME=$DISTRIB_CODENAME
	else
		DEFAULT_CHRNAME=hardy
	fi;
}

function chroots_get_chroot {
	if [ ! -f $CHROOTS ]; then
		echo "File $CHROOTS does not exist. No chroot installed.";
		return 1;
	fi;

	CFG=`grep "^$1 " $CHROOTS` 

	if [ "$CFG" == "" ]; then
		if [ $VERBOSE == 1 ]; then
			echo "$1 does no exist in $CHROOTS"
		fi;
		return 1;
	fi;

	_CHRTARGET=`echo $CFG | cut -d " " -f 2`
	_CHRUSER=`echo $CFG | cut -d " " -f 3`
	_CHRNAME=$1

	return 0;
}

function __chroots_check_mount {
	DEV=$1
	TARGET=$2

	MOUNTOUTPUT=`mount | grep "^$DEV on $TARGET"`

	if [ "$MOUNTOUTPUT" != "" ]; then
		return 1;
	fi;

	return 0;
}

function chroots_check_mount {

	chroots_get_chroot $1;

	if [ $? != 0 ]; then
		echo "Mount check failed because $1 does not exist"
		return 2;
	fi;

	if [ $VERBOSE == 1 ]; then
		echo "Checking if $_CHRNAME is mounted..."
	fi;

	__chroots_check_mount "none" "$_CHRTARGET/proc"
	PROCMOUNT=$?

	__chroots_check_mount "/dev" "$_CHRTARGET/dev"
	DEVMOUNT=$?

	__chroots_check_mount "/tmp" "$_CHRTARGET/tmp"
	TMPMOUNT=$?

	if [ $VERBOSE == 1 ]; then
		if [ $PROCMOUNT == 0 ]; then
			echo "$_CHRTARGET/proc is not mounted"
		fi;

		if [ $DEVMOUNT == 0 ]; then
			echo "$_CHRTARGET/dev is not mounted"
		fi;

		if [ $TMPMOUNT == 0 ]; then
			echo "$_CHRTARGET/tmp is not mounted"
		fi;
	fi;

	if [[ $PROCMOUNT == 1 || $DEVMOUNT == 1 || $TMPMOUNT == 1 ]]; then
		return 1;
	fi;

	return 0;
}



